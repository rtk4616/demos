<!DOCTYPE html>
<html>
<head>
   <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
   <title>Building Web Services (HTTP APIs) with Ruby (and Sinatra)</title>
   
   

<style>
html, body { margin: 0; padding: 0; }

body { font-family: Verdana, Geneva, Arial, Helvetica, sans-serif; }

a:link, a:visited { color: black; }

h1 { font-size: 30pt;  }
h2 { font-size: 28pt;  }
h3 { font-size: 25pt;  }
p, li, dt, dd, td, th { font-size: 18pt; }

pre { font-size: 14pt;  }
pre.small { font-size: 11pt; }

pre.code {
        background-color: azure;
        padding: 5px;
      }
     
ul { list-style-type: square; }    
   
.center { text-align: center; }   
     
.slide { page-break-after: always;
         min-height: 100mm;
         padding: 40px;
         
         border: 1px dotted black;

/*      
  background: -moz-linear-gradient( top, maroon, red);
*/
       }


pre {
  padding: 4px 4px 4px 4px;
  border-top: #bbb 1px solid;
  border-bottom: #bbb 1px solid;
  background: #f3f3f3;
}



/*
for princexml (CSS3 paged media support)
@page { size: A4 landscape }
*/
</style>

</head>
<body>

<div class="presentation">

<div class='slide '>
<!-- === begin markdown block =====================================================

      generated by markdown 1.0.0 on Ruby 1.9.2 (2011-07-09) [i386-mingw32]
                on 2013-09-05 16:44:38 +0200 with Markdown engine kramdown (1.2.0)
                  using options { !to be done! }
  -->


<!-- _S9SLIDE_ -->
<h1 id="agenda">Agenda</h1>

<ul>
  <li>What&#8217;s Sinatra?</li>
  <li>Let a Thousand Sinatra Clones Bloom</li>
  <li>Why Sinatra? Goodies</li>
  <li>Example Web Service (HTTP API) - Routes</li>
  <li>Sinatra in Action - <code>get '/beer/:key'</code></li>
  <li>What&#8217;s JSON? </li>
  <li>What&#8217;s JSONP?</li>
  <li>Serializers - From Ruby Objects to JavaScript Objects</li>
  <li>Appendix: Sinatra Styles - Classic or Modern (Modular)</li>
  <li>Appendix: Database Connection Management</li>
  <li>Appendix: Sinatra Books</li>
  <li>Appendix: What&#8217;s Rack?</li>
</ul>


</div>
<div class='slide '>
<!-- _S9SLIDE_ -->
<h1 id="whats-sinatra">What&#8217;s Sinatra?</h1>

<p>Simple (yet powerful and flexible) micro webframework.</p>

<pre><code>require 'sinatra'

get '/' do
  'Hallo Wien!'
end
</code></pre>

<p>Sinatra itself <a href="https://github.com/sinatra/sinatra/blob/master/lib/sinatra/base.rb">less than 2000 lines of code</a>.  </p>

<p>Installation. Type in your terminal (shell):</p>

<pre><code>$ gem install sinatra
</code></pre>


</div>
<div class='slide '>
<!-- _S9SLIDE_ -->
<h1 id="whats-sinatra-continued">What&#8217;s Sinatra? (Continued)</h1>

<p>Example - <code>hallo.rb</code>:</p>

<pre><code>require 'sinatra'

get '/' do
  'Hallo Wien!'
end
</code></pre>

<p>Run script (server):</p>

<pre><code>$ ruby hallo.rb

&gt;&gt; Sinatra has taken the stage...
&gt;&gt; Listening on 0.0.0.0:4567, CTRL+C to stop
</code></pre>

<p>Open browser:</p>

<p><img src="i/hallosinatra.png" alt="" /></p>


</div>
<div class='slide '>
<!-- _S9SLIDE_ -->
<h1 id="let-a-thousand-sinatra-clones-bloom">Let a Thousand Sinatra Clones Bloom</h1>

<p>Micro Frameworks Inspired by Sinatra</p>

<p>Express.js (in Server-Side JavaScript w/ Node.js):</p>

<pre><code>var express = require( 'express' );
var app = express();

app.get( '/', function( req, res ) {
  res.send( 'Hallo Wien!' );
});

app.listen( 4567 );
</code></pre>

<p>Scotty (in Haskell):</p>

<pre><code>import Web.Scotty

main :: IO ()
main = scotty 4567 $ do
    get "/" $ text "Hallo Wien!"
</code></pre>

<p>Dancer (Perl), Fitzgerald (PHP), Ratpack (Groovy),
Zappa (CoffeeScript), Mercury (Lua), Frank (F#), Nancy (C#/.NET),
Bogart (C), Flask (Python), and <a href="http://en.wikipedia.org/wiki/Sinatra_(software)#Frameworks_inspired_by_Sinatra">many more</a>.</p>


</div>
<div class='slide '>
<!-- _S9SLIDE_ -->
<h1 id="why-sinatra--goodies">Why Sinatra?  Goodies</h1>

<p>1) Single file scripts</p>

<p>2) Easy to package up into a gem. Example:</p>

<pre><code>$ gem install beerdb     # Yes, the beerdb includes a Sinatra app.
</code></pre>

<p>3) Lets you build command line tools. Example:</p>

<pre><code>$ beerdb serve           # Startup web service (HTTP API).
</code></pre>

<p>4) Lets you mount app inside app (including Rails). Example:</p>

<pre><code>mount BeerDb::Server, :at =&gt; '/api/v1'
</code></pre>


</div>
<div class='slide '>
<!-- _S9SLIDE_ -->
<h1 id="example-web-service-http-api---routes">Example Web Service (HTTP API) - Routes</h1>

<p>Lets build a beer and brewery API.</p>

<p>Get beer by key <code>/beer/:key</code>. Examples:</p>

<ul>
  <li><code>/beer/guinness</code></li>
  <li><code>/beer/murphysred</code></li>
  <li><code>/beer/brooklynlager</code></li>
  <li><code>/beer/ottakringerhelles</code></li>
</ul>

<p>Get brewery by key <code>/brewery/:key</code>. Examples:</p>

<ul>
  <li><code>/brewery/guinness</code></li>
  <li><code>/brewery/fullers</code></li>
  <li><code>/brewery/brooklyn</code></li>
  <li><code>/brewery/ottakringer</code></li>
</ul>

<p>Bonus:</p>

<p>Get random beer <code>/beer/rand</code> and random brewery <code>/brewery/rand</code>.</p>


</div>
<div class='slide '>
<!-- _S9SLIDE_ -->
<h1 id="sinatra-in-action---get-beerkey">Sinatra in Action - <code>get '/beer/:key'</code></h1>

<p><code>beerdb/server.rb</code>:</p>

<pre><code>get '/beer/:key' do |key|

  beer = Beer.find_by_key!( key )
  json_or_jsonp( beer.as_json )

end

get '/brewery/:key' do |key|

  brewery = Brewery.find_by_key!( key )
  json_or_jsonp( brewery.as_json )

end
</code></pre>

<p>That&#8217;s it.</p>

<p>Bonus:</p>

<pre><code>get '/beer/:key' do |key|

  if ['r', 'rnd', 'rand', 'random'].include?( key )
    beer = Beer.rnd.first
  else
    beer = Beer.find_by_key!( key )
  end

  json_or_jsonp( beer.as_json )
end

get '/brewery/:key' do |key|

  if ['r', 'rnd', 'rand', 'random'].include?( key )
    brewery = Brewery.rnd.first
  else
    brewery = Brewery.find_by_key!( key )
  end

  json_or_jsonp( brewery.as_json )
end
</code></pre>


</div>
<div class='slide '>
<!-- _S9SLIDE_ -->
<h1 id="whats-json">What&#8217;s JSON?</h1>

<p>JSON = JavaScript Object Notation</p>

<p>Example - <code>GET /beer/ottakringerhelles</code>:</p>

<pre><code>{
  key: "ottakringerhelles",
  title: "Ottakringer Helles",
  synonyms: "16er Blech|16er Hüs'n",
  abv: "5.2",
  og: "11.8",
  tags: [ "lager" ],
  brewery: {
    key: "ottakringer",
    title: "Ottakringer Brauerei"
  },
  country: {
   key: "at",
   title: "Austria"
  }
}
</code></pre>


</div>
<div class='slide '>
<!-- _S9SLIDE_ -->
<h1 id="whats-jsonp">What&#8217;s JSONP?</h1>

<p>JSONP = JSON with Padding.  Why?</p>

<p>Call Home Restriction. Cross-Domain Browser Requests Get Blocked. </p>

<p>Hack: Wrap JSON into a JavaScript function/callback
e.g. <code>functionCallback( &lt;json_data_here&gt; )</code>
and serve as plain old JavaScript.</p>

<p>Example - <code>Content-Type: application/json</code>:</p>

<pre><code>{
  key: "ottakringerhelles",
  title: "Ottakringer Helles",
  synonyms: "16er Blech|16er Hüs'n",
  abv: "5.2",
  ...
}
</code></pre>

<p>becomes <code>Content-Type: application/javascript</code>:</p>

<pre><code>functionCallback(
  {
    key: "ottakringerhelles",
    title: "Ottakringer Helles",
    synonyms: "16er Blech|16er Hüs'n",
    abv: "5.2",
    ...
  }
);
</code></pre>

<p>Bonus: Little Sinatra helper for JSON or JSONP response (depending on callback parameter).</p>

<pre><code>def json_or_jsonp( json )
  callback = params.delete('callback')

  if callback
    content_type :js
    response = "#{callback}(#{json})"
  else
    content_type :json
    response = json
  end
end
</code></pre>


</div>
<div class='slide '>
<!-- _S9SLIDE_ -->
<h1 id="serializers---from-ruby-objects-in-memory-to-javascript-object-in-text">Serializers - From Ruby Objects (in Memory) to JavaScript Object (in Text)</h1>

<p>JSON built into Ruby 2.0 as a standard library. Example:</p>

<pre><code>require 'json'

hash =
{
  key:   "ottakringerhelles",
  title: "Ottakringer Helles"
}
</code></pre>

<h3 id="jsongenerate">1) <code>JSON.generate</code></h3>

<pre><code>puts JSON.generate( hash )

&gt;&gt; {"key":"ottakringerhelles","title":"Ottakringer Helles"}
</code></pre>

<h3 id="tojson">2) <code>#to_json</code></h3>

<pre><code>puts hash.to_json

&gt;&gt;  {"key":"ottakringerhelles","title":"Ottakringer Helles"}
</code></pre>


</div>
<div class='slide '>
<!-- _S9SLIDE_ -->
<h1 id="serializers---from-ruby-objects-in-memory-to-javascript-object-in-text-continued">Serializers - From Ruby Objects (in Memory) to JavaScript Object (in Text) Continued</h1>

<p>Serializers for your Models. Example:</p>

<pre><code>class BeerSerializer

  def initialize( beer )
    @beer = beer
  end

  attr_reader :beer

  def as_json
    data = { key:      beer.key,
             title:    beer.title,
             synonyms: beer.synonyms,
             abv:      beer.abv,
             ...
           }
    data.to_json
  end

end # class BeerSerializer
</code></pre>

<p>And add <code>as_json</code> to your Model. Example:</p>

<pre><code>class Beer &lt; ActiveRecord::Base

  def as_json_v2( opts={} )
    BeerSerializer.new( self ).as_json
  end

end # class Beer
</code></pre>


</div>
<div class='slide '>
<!-- _S9SLIDE_ -->
<h1 id="thats-it-thanks">That&#8217;s it. Thanks.</h1>

<h3 id="questions-comments">Questions? Comments?</h3>

<p>Learn more about Sinatra @ <a href="http://sinatrarb.com"><code>sinatrarb.com</code></a></p>

<p>Learn more about the open beer &#8216;n&#8217; brewery database (<code>beer.db</code>) @ <a href="https://github.com/openbeer"><code>github.com/openbeer</code></a></p>


</div>
<div class='slide '>
<!-- _S9SLIDE_ -->
<h1 id="appendix-sinatra-styles---classic-or-modern-modular">Appendix: Sinatra Styles - Classic or Modern (Modular)</h1>

<pre><code>require 'sinatra'

get '/' do
  'Hallo Wien!'
end
</code></pre>

<p>vs.</p>

<pre><code>require 'sinatra/base'

class Server &lt; Sinatra::Base

  get '/' do
    'Hallo Wien!'
  end

end
</code></pre>


</div>
<div class='slide '>
<!-- _S9SLIDE_ -->
<h1 id="appendix-tip---database-connection-management">Appendix: Tip - Database Connection Management</h1>

<p>Sinatra will NOT auto-magically close your database connection
after every request. It&#8217;s up to you.</p>

<p>1) Use the <code>ConnectionManagement</code> middleware. Example:</p>

<pre><code>Server.use ActiveRecord::ConnectionAdapters::ConnectionManagement
</code></pre>

<p>2) Or do it yourself. Example:</p>

<pre><code>Server.after do
  ActiveRecord::Base.connection.close
end    
</code></pre>


</div>
<div class='slide '>
<!-- _S9SLIDE_ -->
<h1 id="appendix-sinatra-books">Appendix: Sinatra Books</h1>

<p><img src="i/sinatra_up_and_running.gif" alt="" /> Sinatra: Up and Running by Alan Harris, Konstantin Haase;
November 2011, O&#8217;Reilly, 122 Pages</p>

<p><img src="i/jump_start_sinatra.gif" alt="" />  Jump Start Sinatra by Darren Jones;
January 2013, SitePoint, 150 Pages</p>


</div>
<div class='slide '>
<!-- _S9SLIDE_ -->
<h1 id="appendix-whats-rack">Appendix: What&#8217;s Rack?</h1>

<p>Lets you mix &#8216;n&#8217; match servers and apps.</p>

<p>Lets you stack apps inside apps inside apps inside apps inside apps.</p>

<p>Good News: A Sinatra app is a Rack app.</p>

<p>Learn more about Rack @ <a href="http://rack.github.io"><code>rack.github.io</code></a>.</p>

<!-- === end markdown block ===================================================== -->
</div>


  </div> <!-- presentation -->
</body>
</html> 

