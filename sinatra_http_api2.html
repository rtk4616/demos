<!DOCTYPE html>
<html>
<head>
   <meta http-equiv="content-type" content="text/html;charset=utf-8"> 
   <title>Building Web Services (HTTP APIs) with Ruby (and Sinatra)</title>

<meta name="generator" content="Slide Show (S9) 2.3.1 on Ruby 1.9.2 (2011-07-09) [i386-mingw32]">
<meta name="author"    content="Your Name Here" >

<!-- helper/macro that lets you add (CSS3) gradient using headers
     see http://slideshow.rubyforge.org/themes.html
     
     -->

<!-- S6 style sheet links -->
<link rel="stylesheet" href="sinatra_http_api2.css" media="projection" id="styleProjection">
<link rel="stylesheet" href="s6/screen.css"         media="screen"     id="styleScreen">
<link rel="stylesheet" href="s6/print.css"          media="print">

<!-- S6 JS -->
<script src="s6/jquery.js"></script>
<script src="s6/jquery.slideshow.js"></script>
<script>
  $(document).ready( function() {
    Slideshow.init();
  } );

  
</script>

<!-- Better Browser Banner for Microsoft Internet Explorer (IE) -->
<!--[if IE]>
<script src="s6/jquery.microsoft.js"></script>
<![endif]-->



</head>
<body>

<div class="layout"> 
  <div id="header"></div>
  <div id="footer">
    <h1>Your Footer Here</h1>
    <h2>Your Subfooter Here</h2>
  </div>
</div>

<div class="presentation">
   
<div class='slide '>
<!-- === begin markdown block ===

      generated by markdown 1.1.1 on Ruby 1.9.2 (2011-07-09) [i386-mingw32]
                on 2014-09-17 14:45:34 +0200 with Markdown engine kramdown (1.3.3)
                  using options {}
  -->


<!-- _S9SLIDE_ -->
<h1 id="agenda">Agenda</h1>

<ul>
  <li>What&#8217;s Sinatra?</li>
  <li>Let a Thousand Sinatra Clones Bloom</li>
  <li>Why Sinatra? Goodies</li>
  <li>Example Web Service (HTTP JSON API) - Routes</li>
  <li>Sinatra in Action - <code>get '/beer/:key'</code></li>
  <li>What&#8217;s JSON?</li>
  <li>What&#8217;s JSONP? What&#8217;s CORS?</li>
  <li>Serializers - From Ruby Objects to JavaScript Objects</li>
  <li>What&#8217;s Rack?</li>
  <li>Rum, Cuba, Roda - More Micro Webframework Alternatives</li>
  <li>What&#8217;s Metal? Rack v2.0 - Faster, Faster, Faster</li>
  <li>HTTP JSON API - Faster, Faster, Faster</li>
  <li>Appendix: Sinatra Books</li>
  <li>Appendix: &#8220;Real World&#8221; HTTP JSON APIs</li>
  <li>Appendix: JSON Schema</li>
  <li>Appendix: HTTP JSON API Guidlines</li>
</ul>


</div>
<div class='slide '>
<!-- _S9SLIDE_ -->
<h1 id="whats-sinatra">What&#8217;s Sinatra?</h1>

<p>Simple (yet powerful and flexible) micro webframework.</p>

<pre><code>require 'sinatra'

get '/' do
  'Hallo Wien!'
end
</code></pre>

<p>Sinatra itself <a href="https://github.com/sinatra/sinatra/blob/master/lib/sinatra/base.rb">less than 2000 lines of code</a>.  </p>

<p>Installation. Type in your terminal (shell):</p>

<pre><code>$ gem install sinatra
</code></pre>


</div>
<div class='slide '>
<!-- _S9SLIDE_ -->
<h1 id="whats-sinatra-contd">What&#8217;s Sinatra? (Cont&#8217;d)</h1>

<p>Example - <code>hallo.rb</code>:</p>

<pre><code>require 'sinatra'

get '/' do
  'Hallo Wien!'
end
</code></pre>

<p>Run script (server):</p>

<pre><code>$ ruby hallo.rb

&gt;&gt; Sinatra has taken the stage...
&gt;&gt; Listening on 0.0.0.0:4567, CTRL+C to stop
</code></pre>

<p>Open browser:</p>

<p><img src="i/hallosinatra.png" alt="" /></p>


</div>
<div class='slide '>
<!-- _S9SLIDE_ -->
<h1 id="let-a-thousand-sinatra-clones-bloom">Let a Thousand Sinatra Clones Bloom</h1>

<p>Many micro frameworks inspired by Sinatra. Example:</p>

<p>Express.js (in Server-Side JavaScript w/ <strong>Node.js</strong>):</p>

<pre><code>var express = require( 'express' );
var app = express();

app.get( '/', function( req, res ) {
  res.send( 'Hallo Wien!' );
});

app.listen( 4567 );
</code></pre>

<p>Scotty (in <strong>Haskell</strong>):</p>

<p>What&#8217;s Haskell?</p>

<ul>
  <li>Haskell is an advanced purely-functional programming language
e.g. a monad is just a monoid in the category of endofunctors, what&#8217;s the problem?</li>
</ul>

<pre><code>import Web.Scotty

main :: IO ()
main = scotty 4567 $ do
    get "/" $ text "Hallo Wien!"
</code></pre>

<ul>
  <li><strong>Perl</strong>: Dancer</li>
  <li><strong>PHP</strong>: Fitzgerald</li>
  <li><strong>Groovy</strong>: Ratpack</li>
  <li><strong>CoffeeScript</strong>: Zappa</li>
  <li><strong>Lua</strong>: Mercury</li>
  <li><strong>F#/.NET</strong>: Frank</li>
  <li><strong>C#/.NET</strong>: Nancy</li>
  <li><strong>C</strong>: Bogart</li>
  <li><strong>Go</strong>: Martini</li>
  <li><strong>Python</strong>: Flask  (started as an april fool&#8217;s joke - that easy?! - it can&#8217;t be true)</li>
  <li>and <a href="http://en.wikipedia.org/wiki/Sinatra_(software)#Frameworks_inspired_by_Sinatra">many more</a>.</li>
</ul>


</div>
<div class='slide '>
<!-- _S9SLIDE_ -->
<h1 id="why-sinatra--goodies">Why Sinatra?  Goodies</h1>

<p>1) Single file scripts</p>

<p>2) Easy to package up into a gem. Example:</p>

<pre><code>$ gem install beerdb     # Yes, the beerdb gem includes a Sinatra app.
</code></pre>

<p>3) Lets you build command line tools. Example:</p>

<pre><code>$ beerdb serve           # Startup web service (HTTP JSON API).
</code></pre>

<p>4) Lets you mount app inside app (including Rails). Example:</p>

<pre><code>mount BeerDb::Service, at: '/api/v3'
</code></pre>


</div>
<div class='slide '>
<!-- _S9SLIDE_ -->
<h1 id="example-web-service-http-json-api---routes">Example Web Service (HTTP JSON API) - Routes</h1>

<p>Lets build a beer and brewery API.</p>

<p>Get beer by key <code>/beer/:key</code>. Examples:</p>

<ul>
  <li><code>/beer/guinness</code></li>
  <li><code>/beer/murphysred</code></li>
  <li><code>/beer/zipferurtyp</code></li>
  <li><code>/beer/hofstettnergranitbock</code></li>
</ul>

<p>Get brewery by key <code>/brewery/:key</code>. Examples:</p>

<ul>
  <li><code>/brewery/guinness</code></li>
  <li><code>/brewery/murphy</code></li>
  <li><code>/brewery/zipf</code></li>
  <li><code>/brewery/hofstetten</code></li>
</ul>

<p>Bonus:</p>

<p>Get random beer <code>/beer/rand</code> and random brewery <code>/brewery/rand</code>.</p>


</div>
<div class='slide '>
<!-- _S9SLIDE_ -->
<h1 id="sinatra-in-action---get-beerkey">Sinatra in Action - <code>get '/beer/:key'</code></h1>

<p><code>beerdb/server.rb</code>:</p>

<pre><code>include BeerDb::Models

get '/beer/:key' do |key|

  beer = Beer.find_by!( key: key )
  json_or_jsonp( beer.as_json )

end

get '/brewery/:key' do |key|

  brewery = Brewery.find_by!( key: key )
  json_or_jsonp( brewery.as_json )

end
</code></pre>

<p>That&#8217;s it.</p>


</div>
<div class='slide '>
<!-- _S9SLIDE_ -->
<h1 id="bonus-sinatra-in-action---get-beerkey">Bonus: Sinatra in Action - <code>get '/beer/:key'</code></h1>

<pre><code>get '/beer/:key' do |key|

  if ['r', 'rnd', 'rand', 'random'].include?( key )
    beer = Beer.rnd.first
  else
    beer = Beer.find_by!( key: key )
  end

  json_or_jsonp( beer.as_json )
end

get '/brewery/:key' do |key|

  if ['r', 'rnd', 'rand', 'random'].include?( key )
    brewery = Brewery.rnd.first
  else
    brewery = Brewery.find_by!( key: key )
  end

  json_or_jsonp( brewery.as_json )
end
</code></pre>


</div>
<div class='slide '>
<!-- _S9SLIDE_ -->
<h1 id="whats-json">What&#8217;s JSON?</h1>

<p>JSON = JavaScript Object Notation</p>

<p>Example - <code>GET /beer/hofstettnergranitbock</code>:</p>

<pre><code>{
  "key": "hofstettnergranitbock",
  "title": "Hofstettner Granitbock",
  "abv": 7.2,
  "og": 17.8,
  "tags": [ "lager", "bock" ],
  "brewery": {
    "key": "hofstetten",
    "title": "Brauerei Hofstetten"
  },
  "country": {
   "key": "at",
   "title": "Austria"
  }
}
</code></pre>


</div>
<div class='slide '>
<!-- _S9SLIDE_ -->
<h1 id="whats-jsonp--json-p">What&#8217;s JSONP / JSON-P?</h1>

<p>JSONP / JSON-P = JSON with Padding.  Why?</p>

<p>Call Home Restriction. Cross-Domain Browser Requests Get Blocked. </p>

<p>Hack: Wrap JSON into a JavaScript function/callback
e.g. <code>functionCallback( &lt;json_data_here&gt; )</code>
and serve as plain old JavaScript.</p>

<p>Example - <code>Content-Type: application/json</code>:</p>

<pre><code>{
  "key": "hofstettnergranitbock",
  "title": "Hofstettner Granitbock",
  "abv": "7.2",
  ...
}
</code></pre>

<p>becomes <code>Content-Type: application/javascript</code>:</p>

<pre><code>functionCallback(
  {
    "key": "hofstettnergranitbock",
    "title": "Hofstettner Granitbock",
    "abv": 7.2,
    ...
  }
);
</code></pre>

<p>Bonus: Little Sinatra helper for JSON or JSONP response (depending on callback parameter).</p>

<pre><code>def json_or_jsonp( json )
  callback = params.delete('callback')

  if callback
    content_type :js
    response = "#{callback}(#{json})"
  else
    content_type :json
    response = json
  end
end
</code></pre>


</div>
<div class='slide '>
<!-- _S9SLIDE_ -->
<h1 id="whats-cors-cross-origin-resource-sharing---jsonp-v20---http-access-control">What&#8217;s CORS (Cross-Origin Resource Sharing)? - JSONP v2.0 - HTTP Access Control</h1>

<p>CORS = Cross-Origin Resource Sharing</p>

<p>JSONP &#8220;Hack&#8221; no longer needed; let&#8217;s you use &#8220;plain&#8221; standard HTTP requests
in JavaScript; requires a &#8220;modern&#8221; browser</p>

<p>Uses HTTP headers in request and response (for access control).</p>

<h3 id="example-1-simple-get-request">Example 1) Simple GET request</h3>

<p>Browser must send along Origin header in request:</p>

<pre><code>Origin: http://foo.example
</code></pre>

<p>Server must return Access-Control-Allow-Origin header in request to allow access
to browser:</p>

<pre><code>Access-Control-Allow-Origin: *
</code></pre>

<h3 id="example-2-post-pre-flight-request-w-options">Example 2) POST &#8220;pre-flight&#8221; request w/ OPTIONS</h3>

<p>CORS HTTP Request Headers:</p>

<pre><code>Origin: http://example.com
Access-Control-Request-Method: POST
Access-Control-Request-Headers: X-PINGOTHER
</code></pre>

<p>CORS HTTP Response Headers:</p>

<pre><code>Access-Control-Allow-Origin: http://example.com
Access-Control-Allow-Methods: POST, GET, OPTIONS
Access-Control-Allow-Headers: X-PINGOTHER
Access-Control-Max-Age: 1728000
</code></pre>


</div>
<div class='slide '>
<!-- _S9SLIDE_ -->
<h1 id="serializers---from-ruby-objects-in-memory-to-javascript-object-in-text">Serializers - From Ruby Objects (in Memory) to JavaScript Object (in Text)</h1>

<p>JSON built into Ruby 2.x as a standard library. Example:</p>

<pre><code>require 'json'

hash =
{
  key: "hofstettnergranitbock",
  title: "Hofstettner Granitbock"
}
</code></pre>

<h3 id="jsongenerate">1) <code>JSON.generate</code></h3>

<pre><code>puts JSON.generate( hash )

# =&gt; {"key":"hofstettnergranitbock","title":"Hofstettner Granitbock"}
</code></pre>

<h3 id="tojson">2) <code>#to_json</code></h3>

<pre><code>puts hash.to_json

# =&gt;  {"key":"hofstettnergranitbock","title":"Hofstettner Granitbock"}
</code></pre>


</div>
<div class='slide '>
<!-- _S9SLIDE_ -->
<h1 id="serializers---from-ruby-objects-in-memory-to-javascript-object-in-text-contd">Serializers - From Ruby Objects (in Memory) to JavaScript Object (in Text) Cont&#8217;d</h1>

<p>Serializers for your models. Example:</p>

<pre><code>class BeerSerializer

  def initialize( beer )
    @beer = beer
  end

  attr_reader :beer

  def as_json
    data = { key:      beer.key,
             title:    beer.title,
             abv:      beer.abv,
             ...
           }
    data.to_json
  end

end # class BeerSerializer
</code></pre>

<p>And add <code>as_json</code> to your Model. Example:</p>

<pre><code>class Beer &lt; ActiveRecord::Base

  def as_json_v2( opts={} )
    BeerSerializer.new( self ).as_json
  end

end # class Beer
</code></pre>


</div>
<div class='slide '>
<!-- _S9SLIDE_ -->
<h1 id="from-ruby-objects-to-json---many-more-options---jbuilder">From Ruby Objects to JSON - Many More Options - Jbuilder</h1>

<ul>
  <li><a href="https://github.com/rails/jbuilder"><code>rails/jbuilder</code></a> - Create JSON structures via a builder-style DSL</li>
</ul>

<pre><code>json.content format_content(@message.content)
json.(@message, :created_at, :updated_at)

json.author do
  json.name @message.creator.name.familiar
  json.email_address @message.creator.email_address_with_name
  json.url url_for(@message.creator, format: :json)
end

json.comments @message.comments, :content, :created_at

json.attachments @message.attachments do |attachment|
  json.filename attachment.filename
  json.url url_for(attachment)
end
</code></pre>

<p>will create</p>

<pre><code>{
  "content": "&lt;p&gt;This is &lt;i&gt;serious&lt;/i&gt; monkey business&lt;/p&gt;",
  "created_at": "2011-10-29T20:45:28-05:00",
  "updated_at": "2011-10-29T20:45:28-05:00",

  "author": {
    "name": "David H.",
    "email_address": "'David Heinemeier Hansson' &lt;david@heinemeierhansson.com&gt;",
    "url": "http://example.com/users/1-david.json"
  },

  "comments": [
    { "content": "Hello everyone!", "created_at": "2011-10-29T20:45:28-05:00" },
    { "content": "To you my good sir!", "created_at": "2011-10-29T20:47:28-05:00" }
  ],

  "attachments": [
    { "filename": "forecast.xls", "url": "http://example.com/downloads/forecast.xls" },
    { "filename": "presentation.pdf", "url": "http://example.com/downloads/presentation.pdf" }
  ]
}
</code></pre>


</div>
<div class='slide '>
<!-- _S9SLIDE_ -->
<h1 id="from-ruby-objects-to-json---many-more-options---wunderbarjson">From Ruby Objects to JSON - Many More Options - Wunderbar.json</h1>

<ul>
  <li><a href="https://github.com/rubys/wunderbar"><code>rubys/wunderbar</code></a> - Another builder-style DSL </li>
</ul>

<pre><code>Wunderbar.json do
  _content format_content(@message.content)
  _ @message, :created_at, :updated_at 

  _author do
    _name @message.creator.name.familiar
    _email_address @message.creator.email_address_with_name
    _url url_for(@message.creator, format: :json)
  end

  _comments @message.comments, :content, :created_at

  _attachments @message.attachments do |attachment|
    _filename attachment.filename
    _url url_for(attachment)
  end
end
</code></pre>


</div>
<div class='slide '>
<!-- _S9SLIDE_ -->
<h1 id="whats-rack">What&#8217;s Rack?</h1>

<p>Lets you mix &#8216;n&#8217; match servers and apps.</p>

<p>Lets you stack apps inside apps inside apps inside apps inside apps.</p>

<p>Good News: A Sinatra app is a Rack app.</p>

<p>Learn more about Rack @ <a href="http://rack.github.io"><code>rack.github.io</code></a>.</p>

<p><img src="i/racksite.png" alt="" /></p>


</div>
<div class='slide '>
<!-- _S9SLIDE_ -->
<h1 id="whats-rack--contd">What&#8217;s Rack?  Cont&#8217;d</h1>

<p>Mimimalistic Rack App</p>

<pre><code>lambda { |env| [200, {'Content-Type' =&gt; 'text/plain'}, ['Hallo Wien!']] }
</code></pre>

<p>To use Rack, provide an &#8220;app&#8221;: an object that responds to the call method,
taking the environment hash as a parameter, and returning an Array with three elements:</p>

<ul>
  <li>The HTTP response code  e.g. <code>200</code>  </li>
  <li>A Hash of headers e.g. <code>{ 'Content-Type' =&gt; 'text/plain' }</code></li>
  <li>The response body, which must respond to each e.g. <code>["Hallo Wien!"]</code></li>
</ul>

<p><code>hello.rb</code>:</p>

<pre><code>require 'rack'

hello_app =  -&gt;{ |env|
                   [ 200,
                     { 'Content-Type' =&gt; 'text/plain' },
                     [ 'Hallo Wien!' ]
                   ]
               }

Rack::Handler::Webserver.run( hello_app )
</code></pre>


</div>
<div class='slide '>
<!-- _S9SLIDE_ -->
<h1 id="rack-in-action---get-beerkey">Rack in Action - <code>GET '/beer/:key</code></h1>

<p>To be done</p>


</div>
<div class='slide '>
<!-- _S9SLIDE_ -->
<h1 id="real-world-example---stack-rack-apps-inside-rack-apps-inside-rack-apps---sportdbadmin">&#8220;Real World&#8221; Example - Stack Rack Apps inside Rack Apps inside Rack Apps - sport.db.admin</h1>

<p><a href="https://github.com/sportdb/sport.db.admin/blob/master/config/routes.rb"><code>sport.db.admin/config/routes.rb</code></a>:</p>

<pre><code>Sportdbhost::Application.routes.draw do

  mount About::App,     at: '/sysinfo'
  mount DbBrowser::App, at: '/browse'

  get '/api' =&gt; redirect('/api/v1')
  mount SportDb::Service, at: '/api/v1'

  mount LogDb::App, at: '/logs'

  mount SportDbAdmin::Engine, at: '/'

end
</code></pre>


</div>
<div class='slide '>
<!-- _S9SLIDE_ -->
<h1 id="rum-cuba-roda-n-friends---more-micro-framework-alternatives">Rum, Cuba, Roda &#8216;n&#8217; Friends - More Micro Framework Alternatives</h1>

<h3 id="rumhttpsgithubcomchneukirchenrum---grand-unified-mapper-for-rack-apps"><a href="https://github.com/chneukirchen/rum">Rum</a> - gRand Unified Mapper for Rack apps</h3>

<p>First version by Rack inventor Christian Neukirchen in 2008. Example:</p>

<pre><code>App = Rum.new {
    on get, path('greet') do
      on param("name") do |name|
        puts "Hello, #{Rack::Utils.escape_html name}!"
      end
      on default do
        puts "Hallo Wien!"
      end
    end
  }
</code></pre>

<h3 id="cubahttpcubais---tiny-but-powerful-mapper-for-rack-apps"><a href="http://cuba.is">Cuba</a> - Tiny but powerful Mapper for Rack apps</h3>

<p>Uses the idea of Rum (thus, the name Cuba) and adds a little more machinery.
Example:</p>

<pre><code>on get, "articles/:id" do |id|
  article = Article[id]

  on "comments/:id" do |id|
    comment = article.comments[id]
  end
end
</code></pre>

<h3 id="rodahttprodajeremyevansnet---routing-tree-webframework"><a href="http://roda.jeremyevans.net">Roda</a> - Routing Tree Webframework</h3>

<p>Uses the idea of Cuba and adds yet more machinery
(e.g. better request tree, plugins, etc.). Example:</p>

<pre><code>route do |r|
  # GET / request
  r.root do
    r.redirect "/hello"
  end

  # /hello branch
  r.on "hello" do

    # GET /hello/world request
    r.get "world" do
      "Hello world!"
    end

    # /hello request
    r.is do
      # GET /hello request
      r.get do
        "Hello!"
      end

      # POST /hello request
      r.post do
        puts "Someone said hello!"
        r.redirect
      end
    end
  end
end
</code></pre>


</div>
<div class='slide '>
<!-- _S9SLIDE_ -->
<h1 id="rum-cuba-roda-n-friends---more-micro-framework-alternatives-contd">Rum, Cuba, Roda &#8216;n&#8217; Friends - More Micro Framework Alternatives (Cont&#8217;d)</h1>

<p>Why? Why? Why?</p>

<p>Assumption less lines of code =&gt; faster code, more requests/secs - only use what you need</p>

<table>
  <thead>
    <tr>
      <th>Library</th>
      <th>Lines of Code (LOC)</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Cuba</td>
      <td>152</td>
    </tr>
    <tr>
      <td>Sinatra</td>
      <td>1_476</td>
    </tr>
    <tr>
      <td>Rails (*)</td>
      <td>13_181</td>
    </tr>
    <tr>
      <td>(Almost) Sinatra</td>
      <td>7</td>
    </tr>
  </tbody>
</table>

<p>(*) only ActionPack (Rails is over 40_000+ LOC)</p>

<p>(Source: <a href="http://files.soveran.com/cuba/#11">Cuba Slides</a>, <a href="https://github.com/rkh/almost-sinatra">(Almost) Sinatra</a>)</p>


</div>
<div class='slide '>
<!-- _S9SLIDE_ -->
<h1 id="micro-benchmarks---requestssec---memory-allocationrequest">Micro Benchmarks - Requests/sec - Memory Allocation/Request</h1>

<p>Collected on:</p>

<ul>
  <li>OSX, 10.8.5, MacBook Pro i5 (2.5GHz), 8GiG 1600 MHz DDR3.</li>
  <li>ruby 2.1.2p95 (GCC 4.7.3)</li>
</ul>

<table>
  <thead>
    <tr>
      <th>Library</th>
      <th>Requests/sec</th>
      <th>% from best</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>rack</td>
      <td>8808.83</td>
      <td>100.0 %</td>
    </tr>
    <tr>
      <td>roda</td>
      <td>7182.15</td>
      <td>81.53 %</td>
    </tr>
    <tr>
      <td>rack-response</td>
      <td>6876.73</td>
      <td>78.07 %</td>
    </tr>
    <tr>
      <td>cuba</td>
      <td>6159.57</td>
      <td>69.92 %</td>
    </tr>
    <tr>
      <td>sinatra</td>
      <td>2899.94</td>
      <td>32.92 %</td>
    </tr>
  </tbody>
</table>

<table>
  <thead>
    <tr>
      <th>Library</th>
      <th>Allocs/Req</th>
      <th>Memsize/Req</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>rack</td>
      <td>60</td>
      <td>1704</td>
    </tr>
    <tr>
      <td>roda</td>
      <td>71</td>
      <td>2144</td>
    </tr>
    <tr>
      <td>rack-response</td>
      <td>83</td>
      <td>3072</td>
    </tr>
    <tr>
      <td>cuba</td>
      <td>100</td>
      <td>3457</td>
    </tr>
    <tr>
      <td>sinatra</td>
      <td>253</td>
      <td>10011</td>
    </tr>
  </tbody>
</table>

<p>(Source: <a href="https://github.com/luislavena/bench-micro"><code>luislavena/bench-micro</code></a>)</p>

<p>Notes</p>

<pre><code>$ wrk -t 2 http://localhost:9292/
</code></pre>

<p>All the micro frameworks were run using Puma on Ruby 2.1,<br />
in production mode and using 16 threads:</p>

<pre><code>$ puma -e production -t 16:16 apps/(rack.ru|rodo.ru|rack-response.ru|cuba.ru|sinatra.ru)
</code></pre>

<p><code>sinatra.ru</code>:</p>

<pre><code>require "sinatra/base"

class HelloWorld &lt; Sinatra::Base
  get "/" do
    "Hello World!"
  end
end

App = HelloWorld
run App
</code></pre>

<p><code>rack.ru</code>:</p>

<pre><code>class HelloWorld
  def call(env)
    if env['REQUEST_METHOD'] == 'GET' &amp;&amp; env['PATH_INFO'] == '/'
      [
        200,
        {"Content-Type" =&gt; "text/html"},
        ["Hello World!"]
      ]
    else
     [
       404,
       {"Content-Type" =&gt; "text/html"},
       [""]
     ]
    end
  end
end

App = HelloWorld.new
run App
</code></pre>

<p><code>rack-response.ru</code>:</p>

<pre><code>class HelloWorld
  def call(env)
    if env['REQUEST_METHOD'] == 'GET' &amp;&amp; env['PATH_INFO'] == '/'
      Rack::Response.new('Hello World!', 200, { 'Content-Type' =&gt; 'text/html' }).finish
    else
      Rack::Response.new('', 404, { 'Content-Type' =&gt; 'text/html' }).finish
    end
  end
end

App = HelloWorld.new
run App
</code></pre>


</div>
<div class='slide '>
<!-- _S9SLIDE_ -->
<h1 id="whats-metal---rack-v20----faster-faster-faster">What&#8217;s Metal? - Rack v2.0  - Faster, Faster, Faster</h1>

<p>Q: Why update (break) Rack v1.0?</p>

<p>A: Make it faster, faster, faster. Non-blocking streaming with asynchronous event callbacks is the new black.</p>

<p>An app without any middleware:</p>

<pre><code>hello_app = -&gt;(req, res) {
                 res.write_head( 200, 'Content-Type' =&gt; 'text/plain' )
                 res.write( "Hallo Wien!\n" )
                 res.finish
              }

require 'the_metal/puma'

server = TheMetal.create_server( hello_app )
server.listen( 9292, '0.0.0.0' )
</code></pre>

<p>You can use a class too:</p>

<pre><code>class App
  def call( req, res )
    res.write_head( 200, 'Content-Type' =&gt; 'text/plain' )
    res.write( "Hallo Wien!\n" )
    res.finish
  end
end

require 'the_metal/puma'

server = TheMetal.create_server( App.new )
server.listen( 9292, '0.0.0.0' )
</code></pre>


</div>
<div class='slide '>
<!-- _S9SLIDE_ -->
<h1 id="whats-metal---rack-v20---contd">What&#8217;s Metal? - Rack v2.0 - Cont&#8217;d</h1>

<p>An app that checks out a database connection when the request starts
and checks it back in when the response is finished:</p>

<pre><code>require 'the_metal'

class App
  def call( req, res )
    res.write_head( 200, 'Content-Type' =&gt; 'text/plain' )
    res.write( "Hallo Wien!\n" )
    res.finish
  end
end

class DbEvents
  def start_app( app )
    puts "ensure database connection"
  end

  def start_request( req, res )
    puts "-&gt; checkout connection"
  end

  def finish_request( req, res )
    puts "&lt;- checkin connection"
  end
end

require 'the_metal/puma'

app = TheMetal.build_app( [DbEvents.new], [], App.new )

server = TheMetal.create_server( app )
server.listen( 9292, '0.0.0.0' )
</code></pre>


</div>
<div class='slide '>
<!-- _S9SLIDE_ -->
<h1 id="http-json-apis---faster-faster-faster---try-another-language">HTTP JSON APIs - Faster, Faster, Faster - Try Another Language</h1>

<p>Trivia Quiz: What language is this?</p>

<pre><code>func GetEvents() interface{} {
  // step 1: fetch records
  events := FetchEvents()
  log.Println( events )

  // step 2: map to json structs for serialization/marshalling
  type JsEvent struct {
    Key   string `json:"key"`
    Title string `json:"title"`
  }
  data := []*JsEvent{}

  for _,event := range events {
   data = append( data, &amp;JsEvent {
                          Key:   event.Key,
                          Title: event.Title, } )
  }
  return data
}
</code></pre>


</div>
<div class='slide '>
<!-- _S9SLIDE_ -->
<h1 id="http-json-apis---faster-faster-faster---why-go">HTTP JSON APIs - Faster, Faster, Faster - Why Go?</h1>

<p>Just an example. Use what works for you. Why Go?</p>

<p>Kind of a &#8220;better&#8221; more &#8220;modern&#8221; C.</p>

<p>Code gets compiled (to machine-code ahead-of-time) and linked
to let you build (small-ish) zero-dependency
all-in-one binary (file) programs.</p>

<p>No virtual machine or byte code runtime or just-in-time compiler machinery needed;
includes garbage collector.</p>


</div>
<div class='slide '>
<!-- _S9SLIDE_ -->
<h1 id="http-json-apis---faster-faster-faster---nosql-version">HTTP JSON APIs - Faster, Faster, Faster - NoSQL Version</h1>

<p>Try a NoSQL database and get JSON HTTP APIs (almost) for &#8220;free&#8221;.</p>


</div>
<div class='slide '>
<!-- _S9SLIDE_ -->
<h1 id="thats-it-thanks">That&#8217;s it. Thanks.</h1>

<h3 id="questions-comments">Questions? Comments?</h3>

<p>Learn more about Sinatra @ <a href="http://sinatrarb.com"><code>sinatrarb.com</code></a></p>

<p>Learn more about the open beer &#8216;n&#8217; brewery database (<code>beer.db</code>) @ <a href="https://github.com/openbeer"><code>github.com/openbeer</code></a></p>


</div>
<div class='slide '>
<!-- _S9SLIDE_ -->
<h1 id="appendix-sinatra-styles---classic-or-modern-modular">Appendix: Sinatra Styles - Classic or Modern (Modular)</h1>

<pre><code>require 'sinatra'

get '/' do
  'Hallo Wien!'
end
</code></pre>

<p>vs.</p>

<pre><code>require 'sinatra/base'

class App &lt; Sinatra::Base

  get '/' do
    'Hallo Wien!'
  end

end
</code></pre>


</div>
<div class='slide '>
<!-- _S9SLIDE_ -->
<h1 id="appendix-sinatra-books">Appendix: Sinatra Books</h1>

<p><img src="i/sinatra_up_and_running.gif" alt="" /> Sinatra: Up and Running by Alan Harris, Konstantin Haase;
November 2011, O&#8217;Reilly, 122 Pages</p>

<p><img src="i/jump_start_sinatra.gif" alt="" />  Jump Start Sinatra by Darren Jones;
January 2013, SitePoint, 150 Pages</p>


</div>
<div class='slide '>
<!-- _S9SLIDE_ -->
<h1 id="appendix-more-micro-framework-alternatives">Appendix: More Micro Framework Alternatives</h1>

<h3 id="grapehttpsgithubcomintrideagrape---micro-framework-for-creating-rest-like-apis"><a href="https://github.com/intridea/grape">Grape</a> - Micro framework for creating REST-like APIs</h3>

<pre><code>require 'grape'

class API &lt; Grape::API
  get :hello do
    { hello: "world" }
  end
end
</code></pre>

<h3 id="crpehttpsgithubcomcrepecrepe---the-thin-api-stack"><a href="https://github.com/crepe/crepe">Crêpe</a> - The thin API stack</h3>

<pre><code>require 'crepe'

class API &lt; Crepe::API
   get :hello do 
    { hello: "world" }
   end
end
</code></pre>


</div>
<div class='slide '>
<!-- _S9SLIDE_ -->
<h1 id="appendix-real-world-http-json-apis-examples">Appendix: &#8220;Real-World&#8221; HTTP JSON APIs Examples</h1>

<p>Learn from the &#8220;masters&#8221;. Examples:</p>

<ul>
  <li>GitHub API  -&gt;  <a href="https://developer.github.com/v3">developer.github.com/v3</a></li>
  <li>Basecamp API -&gt; <a href="https://github.com/basecamp/api">github.com/basecamp/api</a></li>
  <li>Heroku API  -&gt;  <a href="https://devcenter.heroku.com/categories/platform-api">devcenter.heroku.com/categories/platform-api</a></li>
  <li>Travis CI API -&gt; <a href="http://docs.travis-ci.com/api">docs.travis-ci.com/api</a></li>
  <li>Many more</li>
</ul>

<pre><code>$ curl -i https://api.github.com/users/octocat/orgs
</code></pre>

<p>Headers:</p>

<pre><code>HTTP/1.1 200 OK
Server: nginx
Date: Fri, 12 Oct 2012 23:33:14 GMT
Content-Type: application/json; charset=utf-8
Connection: keep-alive
Status: 200 OK
ETag: "a00049ba79152d03380c34652f2cb612"
X-GitHub-Media-Type: github.v3
X-RateLimit-Limit: 5000
X-RateLimit-Remaining: 4987
X-RateLimit-Reset: 1350085394
Content-Length: 5
Cache-Control: max-age=0, private, must-revalidate
X-Content-Type-Options: nosniff
</code></pre>

<p>JSON Payload:</p>

<pre><code>[]
</code></pre>


</div>
<div class='slide '>
<!-- _S9SLIDE_ -->
<h1 id="appendix-github-http-json-api-example---list-commits-on-a-repo">Appendix: GitHub HTTP JSON API Example - List Commits on a Repo</h1>

<pre><code>GET /repos/:owner/:repo/commits
</code></pre>

<p>Headers:</p>

<pre><code>Status: 200 OK
Link: &lt;https://api.github.com/resource?page=2&gt;; rel="next"
X-RateLimit-Limit: 5000
X-RateLimit-Remaining: 4999
</code></pre>

<p>JSON Payload:</p>

<pre><code>[
  {
    "url": "https://api.github.com/repos/octocat/Hello-World/commits/6dcb09b5b57875f334f61aebed695e2e4193db5e",
    "sha": "6dcb09b5b57875f334f61aebed695e2e4193db5e",
    "html_url": "https://github.com/octocat/Hello-World/commit/6dcb09b5b57875f334f61aebed695e2e4193db5e",
    "comments_url": "https://api.github.com/repos/octocat/Hello-World/commits/6dcb09b5b57875f334f61aebed695e2e4193db5e/comments",
    "commit": {
      "url": "https://api.github.com/repos/octocat/Hello-World/git/commits/6dcb09b5b57875f334f61aebed695e2e4193db5e",
      "author": {
        "name": "Monalisa Octocat",
        "email": "support@github.com",
        "date": "2011-04-14T16:00:49Z"
      },
      "committer": {
        "name": "Monalisa Octocat",
        "email": "support@github.com",
        "date": "2011-04-14T16:00:49Z"
      },
      "message": "Fix all the bugs",
      "tree": {
        "url": "https://api.github.com/repos/octocat/Hello-World/tree/6dcb09b5b57875f334f61aebed695e2e4193db5e",
        "sha": "6dcb09b5b57875f334f61aebed695e2e4193db5e"
      },
      "comment_count": 0
    },
    "author": {
      "login": "octocat",
      "id": 1,
      "avatar_url": "https://github.com/images/error/octocat_happy.gif",
      "gravatar_id": "somehexcode",
      "url": "https://api.github.com/users/octocat",
      "html_url": "https://github.com/octocat",
      "followers_url": "https://api.github.com/users/octocat/followers",
      "following_url": "https://api.github.com/users/octocat/following{/other_user}",
      "gists_url": "https://api.github.com/users/octocat/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/octocat/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/octocat/subscriptions",
      "organizations_url": "https://api.github.com/users/octocat/orgs",
      "repos_url": "https://api.github.com/users/octocat/repos",
      "events_url": "https://api.github.com/users/octocat/events{/privacy}",
      "received_events_url": "https://api.github.com/users/octocat/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "octocat",
      "id": 1,
      "avatar_url": "https://github.com/images/error/octocat_happy.gif",
      "gravatar_id": "somehexcode",
      "url": "https://api.github.com/users/octocat",
      "html_url": "https://github.com/octocat",
      "followers_url": "https://api.github.com/users/octocat/followers",
      "following_url": "https://api.github.com/users/octocat/following{/other_user}",
      "gists_url": "https://api.github.com/users/octocat/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/octocat/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/octocat/subscriptions",
      "organizations_url": "https://api.github.com/users/octocat/orgs",
      "repos_url": "https://api.github.com/users/octocat/repos",
      "events_url": "https://api.github.com/users/octocat/events{/privacy}",
      "received_events_url": "https://api.github.com/users/octocat/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "url": "https://api.github.com/repos/octocat/Hello-World/commits/6dcb09b5b57875f334f61aebed695e2e4193db5e",
        "sha": "6dcb09b5b57875f334f61aebed695e2e4193db5e"
      }
    ]
  }
]
</code></pre>


</div>
<div class='slide '>
<!-- _S9SLIDE_ -->
<h1 id="appendix-json-schema">Appendix: JSON Schema</h1>

<p>Project site -&gt; <a href="http://json-schema.org"><code>json-schema.org</code></a></p>

<p>What&#8217;s JSON Schema?</p>

<p>Describe your data structure &#8216;n&#8217; types (schema) in JSON. Example:</p>

<pre><code>{
  "title": "Example Schema",
  "type": "object",
  "properties": {
    "firstName": {
      "type": "string"
    },
    "lastName": {
      "type": "string"
    },
    "age": {
      "description": "Age in years",
      "type": "integer",
      "minimum": 0
    }
  },
  "required": ["firstName", "lastName"]
}
</code></pre>

<p>Why?</p>

<p>Pros:</p>

<ul>
  <li>More tooling
    <ul>
      <li>auto-generate docu</li>
      <li>auto-generate tests</li>
      <li>auto-generate (test) client libraries</li>
      <li>auto-generate validator (for required fields, types, etc.)</li>
    </ul>
  </li>
  <li>More (re)use
    <ul>
      <li>(re)use &#8220;common&#8221; schemas</li>
    </ul>
  </li>
</ul>


</div>
<div class='slide '>
<!-- _S9SLIDE_ -->
<h1 id="appendix-http-json-api-design-guidelines">Appendix: HTTP JSON API Design Guidelines</h1>

<p>Example: Heroku API Design Guidelines</p>

<ul>
  <li>Require TLS</li>
  <li>Version with Accepts header</li>
  <li>Support caching with Etags</li>
  <li>Trace requests with Request-Ids</li>
  <li>Paginate with ranges</li>
  <li>Requests
    <ul>
      <li>Return appropriate status codes</li>
      <li>Provide full resources where available</li>
      <li>Accept serialized JSON in request bodies</li>
      <li>Use consistent path formats</li>
      <li>Downcase paths and attributes</li>
      <li>Support non-id dereferencing for convenience</li>
      <li>Minimize path nesting</li>
    </ul>
  </li>
  <li>Responses
    <ul>
      <li>Provide resource (UU)IDs</li>
      <li>Provide standard timestamps</li>
      <li>Use UTC times formatted in ISO8601</li>
      <li>Nest foreign key relations</li>
      <li>Generate structured errors</li>
      <li>Show rate limit status</li>
      <li>Keep JSON minified in all responses</li>
    </ul>
  </li>
</ul>

<p>(Source: <a href="https://github.com/interagent/http-api-design"><code>github.com/interagent/http-api-design</code></a>)</p>

<p>Note: Site also includes Sinatra starter templates and generators.</p>


</div>
<div class='slide '>
<!-- _S9SLIDE_ -->
<h1 id="appendix-http-json-api-design-guidelines-contd">Appendix: HTTP JSON API Design Guidelines (Cont&#8217;d)</h1>

<p>{json:api} Project - <a href="http://jsonapi.org"><code>jsonapis.org</code></a></p>

<p>A(nother) standard for building APIs in JSON. Example:</p>

<pre><code>{
  "links": {
    "posts.author": {
      "href": "http://example.com/people/{posts.author}",
      "type": "people"
    },
    "posts.comments": {
      "href": "http://example.com/comments/{posts.comments}",
      "type": "comments"
    }
  },
  "posts": [{
    "id": "1",
    "title": "Rails is Omakase",
    "links": {
      "author": "9",
      "comments": [ "5", "12", "17", "20" ]
    }
  }]
}
</code></pre>


</div>
<div class='slide '>
<!-- _S9SLIDE_ -->
<h1 id="appendix-http-json-api-design-guidelines-contd-1">Appendix: HTTP JSON API Design Guidelines (Cont&#8217;d)</h1>

<p>Article:<a href="http://www.vinaysahni.com/best-practices-for-a-pragmatic-restful-api">Best Practices for Designing a Pragmatic RESTful API</a>
by Vinay Sahni</p>

<p>TL;DR</p>

<ul>
  <li>An API is a user interface for a developer - so put some effort into making it pleasant</li>
  <li>Use RESTful URLs and actions</li>
  <li>Use SSL everywhere, no exceptions</li>
  <li>An API is only as good as its documentation - so have great documentation</li>
  <li>Version via the URL, not via headers</li>
  <li>Use query parameters for advanced filtering, sorting &amp; searching</li>
  <li>Provide a way to limit which fields are returned from the API</li>
  <li>Return something useful from POST, PATCH &amp; PUT requests</li>
  <li>HATEOAS isn&#8217;t practical just yet</li>
  <li>Use JSON where possible, XML only if you have to</li>
  <li>You should use camelCase with JSON, but snake_case is 20% easier to read</li>
  <li>Pretty print by default &amp; ensure gzip is supported</li>
  <li>Don&#8217;t use response envelopes by default</li>
  <li>Consider using JSON for POST, PUT and PATCH request bodies</li>
  <li>Paginate using Link headers</li>
  <li>Provide a way to autoload related resource representations</li>
  <li>Provide a way to override the HTTP method</li>
  <li>Provide useful response headers for rate limiting</li>
  <li>Use token based authentication, transported over OAuth2 where delegation is needed</li>
  <li>Include response headers that facilitate caching</li>
  <li>Define a consumable error payload</li>
  <li>Effectively use HTTP Status codes</li>
</ul>


</div>
<div class='slide '>
<!-- _S9SLIDE_ -->
<h1 id="appendix-http-json-api-design-guidelines-contd-2">Appendix: HTTP JSON API Design Guidelines (Cont&#8217;d)</h1>

<p>Books</p>

<p><img src="i/restful_web_apis.gif" alt="" />  RESTful Web APIs by Leonard Richardson, Mike Amundsen;
September 2013; O&#8217;Reilly 408 Pages</p>

<ul>
  <li>Examine API design strategies, including the collection pattern and pure hypermedia</li>
  <li>Understand how hypermedia ties representations together into a coherent API</li>
  <li>Discover how XMDP and ALPS profile formats can help you meet the Web API &#8220;semantic challenge&#8221;</li>
  <li>Learn close to two-dozen standardized hypermedia data formats</li>
  <li>Apply best practices for using HTTP in API implementations</li>
  <li>Create Web APIs with the JSON-LD standard and other the Linked Data approaches</li>
  <li>Understand the CoAP protocol for using REST in embedded systems</li>
</ul>

<p><img src="i/rest_api_design_rulebook.gif" alt="" />
REST API Design Rulebook: Designing Consistent RESTful Web Service Interfaces
by Mark Masse; October 2011; O&#8217;Reilly; 116 Pages</p>

<p>And many more</p>

<ul>
  <li>Designing Hypermedia APIs by Steve Klabnik</li>
  <li>RESTful Web Services Cookbook - Solutions for Improving Scalability and Simplicity
by Subbu Allamaraju; February 2010; O&#8217;Reilly (Yahoo Press)</li>
  <li>REST in Practice - Hypermedia and Systems Architecture
by Jim Webber, Savas Parastatidis, Ian Robinson
September 2010; O&#8217;Reilly </li>
  <li>CORS in Action: Creating and consuming cross-origin APIs by Monsur Hossain;
October 2014; Manning</li>
  <li>Getting Started with OAuth 2.0 - Programming clients for secure web API authorization and authentication
by Ryan Boyd; February 2012; O&#8217;Reilly</li>
  <li>And so on.</li>
</ul>

<!-- === end markdown block === -->
</div>


</div><!-- presentation -->
</body>
</html>